{% extends "base.html" %}
{% block content %}
<div class="card" style="background:transparent; box-shadow:none; border:none; padding:0;">
  
  <div style="background:white; padding:20px; border-radius:10px; margin-bottom:20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
    <div>
        <h2 style="margin: 0; color: #005826;">ğŸ“¢ æ ¡å›­å…¬å‘Šæ  & å°åœºé€šçŸ¥</h2>
        <span style="font-size:13px; color:#666;">æŸ¥çœ‹å…¨æ ¡é€šçŸ¥ï¼Œä»¥åŠåœºé¦†ç»´ä¿®ã€èµ›äº‹å ç”¨æƒ…å†µ</span>
    </div>
  </div>

  {% if user.role == 'ç®¡ç†å‘˜' %}
  <div style="background:#f0fdf4; border:1px solid #86efac; padding:25px; border-radius:10px; margin-bottom:25px;">
    <h4 style="margin-top:0; color:#166534; margin-bottom:15px;">âœï¸ å‘å¸ƒæ–°å…¬å‘Š / è®¾ç½®å°åœº</h4>
    <form method="post">
        <div style="display:flex; gap:15px; margin-bottom:15px;">
            <select name="type" id="announceType" onchange="toggleFields()" style="padding:10px; border-radius:5px; border:1px solid #ddd; flex:1;">
                <option value="é€šçŸ¥">ğŸ“¢ æ ¡å›­é€šçŸ¥</option>
                <option value="å°åœº">ğŸš« ä¸´æ—¶å°åœº</option>
                <option value="ç»´ä¿®">ğŸ› ï¸ åœºåœ°ç»´ä¿®</option>
                <option value="èµ›äº‹">ğŸ† èµ›äº‹å ç”¨</option>
            </select>
            <input name="title" placeholder="å…¬å‘Šæ ‡é¢˜" required style="padding:10px; border-radius:5px; border:1px solid #ddd; flex:3;">
        </div>

        <div id="fieldSelection" style="display:none; flex-direction:column; gap:12px; margin-bottom:15px; background:white; padding:15px; border-radius:8px; border:1px solid #e2e8f0;">
            <div style="display:flex; gap:10px; align-items:center;">
                <label style="font-size:13px; font-weight:bold; white-space:nowrap;">é€‰æ‹©åœºåœ°:</label>
                <select name="field_id" style="padding:8px; border-radius:4px; border:1px solid #ddd; flex:1;">
                    <option value="">-- å…¨é¦†/é€šç”¨ --</option>
                    {% for f in fields %}
                    <option value="{{ f.åœºåœ°ID }}">{{ f.æ ¡åŒº }}-{{ f.åœºé¦†åç§° }}-{{ f.åœºåœ°åç§° }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                <label style="font-size:13px; font-weight:bold; white-space:nowrap;">å°åœºæ—¥æœŸ:</label>
                <input type="date" name="block_date" style="padding:8px; border-radius:4px; border:1px solid #ddd;">
                
                <label style="font-size:13px; font-weight:bold; white-space:nowrap; margin-left:10px;">å…·ä½“æ—¶æ®µ:</label>
                <input type="time" name="start_time" style="padding:8px; border-radius:4px; border:1px solid #ddd;">
                <span>è‡³</span>
                <input type="time" name="end_time" style="padding:8px; border-radius:4px; border:1px solid #ddd;">
            </div>
            <p style="margin:0; font-size:12px; color:#666;">* åªæœ‰åœ¨æŒ‡å®šæ—¥æœŸå’Œæ—¶æ®µå†…çš„é¢„çº¦ä¼šè¢«æ‹¦æˆª</p>
        </div>

        <textarea name="content" placeholder="è¯¦ç»†å†…å®¹æè¿°..." required style="width:100%; padding:10px; border-radius:5px; border:1px solid #ddd; height:100px; margin-bottom:15px;"></textarea>
        <button type="submit" class="btn" style="width:100%; font-weight:bold; letter-spacing:1px;">ç«‹å³å‘å¸ƒå…¬å‘Š</button>
    </form>
  </div>
  <script>
    function toggleFields() {
        var type = document.getElementById('announceType').value;
        document.getElementById('fieldSelection').style.display = (type === 'é€šçŸ¥') ? 'none' : 'flex';
    }
  </script>
  {% endif %}

  <div style="display:flex; flex-direction:column; gap:15px;">
    {% for r in rows %}
      {% set color = '#005826' %}
      {% if r['å…¬å‘Šç±»å‹'] == 'å°åœº' %}{% set color = '#dc2626' %}
      {% elif r['å…¬å‘Šç±»å‹'] == 'ç»´ä¿®' %}{% set color = '#d97706' %}
      {% elif r['å…¬å‘Šç±»å‹'] == 'èµ›äº‹' %}{% set color = '#2563eb' %}{% endif %}

      <div style="display:flex; background:#fff; border-radius:8px; overflow:hidden; box-shadow:0 2px 5px rgba(0,0,0,0.05); border:1px solid #e5e7eb;">
        <div style="width:6px; background-color:{{ color }};"></div>
        <div style="padding:20px; flex:1;">
          <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
              <span style="background:{{ color }}; color:white; padding:2px 10px; border-radius:12px; font-size:12px; font-weight:bold;">{{ r['å…¬å‘Šç±»å‹'] }}</span>
              <span style="font-family:monospace; color:#9ca3af; font-size:13px;">{{ r['å¼€å§‹æ—¶é—´']|string|replace("T", " ") }}</span>
          </div>
          
          <h3 style="margin:0 0 10px 0; color:#333;">
              {% if 'ã€å…¨é¦†å°é”ã€‘' in r['æ ‡é¢˜'] %}
                  <span style="color:{{ color }}; font-weight: bold;">ã€å…¨é¦†å°é”ã€‘</span>
                  <span>{{ r['æ ‡é¢˜'].replace('ã€å…¨é¦†å°é”ã€‘', '') }}</span>
              {% else %}
                  {% if r['å…¬å‘Šç±»å‹'] != 'é€šçŸ¥' and r['åœºåœ°åç§°'] %}
                      <span style="color:{{ color }};">[{{ r['åœºåœ°åç§°'] }}]</span>
                  {% endif %}
                  {{ r['æ ‡é¢˜'] }}
              {% endif %}
          </h3>
          
          {% if '(æ—¶é—´:' in r['å†…å®¹'] %}
            <div style="background:#fef2f2; color:#991b1b; padding:8px 12px; border-radius:6px; margin-bottom:12px; font-size:13px; border:1px solid #fee2e2;">
                <i class="fa-regular fa-clock"></i> <strong>å—å½±å“æ—¶æ®µï¼š</strong>
                {{ r['å†…å®¹'].split('(æ—¶é—´:')[1].replace(')', '') }}
            </div>
            <p style="margin:0 0 15px 0; color:#666; font-size:14px; line-height: 1.6;">{{ r['å†…å®¹'].split('(æ—¶é—´:')[0] }}</p>
          {% else %}
            <p style="margin:0 0 15px 0; color:#666; font-size:14px; line-height: 1.6;">{{ r['å†…å®¹'] }}</p>
          {% endif %}
          
          <div style="border-top:1px solid #f3f4f6; padding-top:12px; display:flex; justify-content:space-between; align-items:center;">
            <div style="font-size:12px; color:#888;">
                ğŸ‘¤ å‘å¸ƒäººï¼š{{ r['å‘å¸ƒäººå§“å'] or r['å‘å¸ƒäºº'] or 'ç®¡ç†å‘˜' }}
            </div>
            {% if user.role == 'ç®¡ç†å‘˜' %}
            <form method="post" onsubmit="return confirm('ç¡®å®šåˆ é™¤æ­¤å…¬å‘Šå—ï¼Ÿ');">
                <input type="hidden" name="action" value="delete">
                <input type="hidden" name="announcement_id" value="{{ r['å…¬å‘ŠID'] }}">
                <button type="submit" style="background:none; border:none; color:#dc2626; cursor:pointer; font-size:12px;">åˆ é™¤å…¬å‘Š</button>
            </form>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>
{% endblock %}